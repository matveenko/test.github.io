<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mental Meridian Hub</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            /* --- PALETTE --- */
            --bg-body: #1a1a1a;
            --bg-card: #2d2d2d;
            --text-main: #FFFFFF;
            --text-sec: #AAAAAA;
            --accent-sunray: #E3BC57;
            --accent-purple: #9D00FF;
            --danger-red: #cf0a0a;
            --danger-dark: #900000;
            --highlight-bg: rgba(157, 0, 255, 0.4); 
            
            --radius: 16px;
            --shadow: 0 10px 25px rgba(0,0,0,0.5);
            --sheet-bg: #1f1f1f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            padding-bottom: 40px;
            opacity: 0; 
            animation: fadeInPage 0.3s ease-out forwards;
            min-height: 100vh;
        }

        @keyframes fadeInPage { to { opacity: 1; } }
        @keyframes glideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .glide-entry { opacity: 0; animation: glideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        @keyframes shimmer { 0% { transform: translateX(-100%) skewX(-15deg); } 100% { transform: translateX(200%) skewX(-15deg); } }

        /* --- HEADER --- */
        .header-container {
            position: fixed; top: 0; left: 0; width: 100%;
            background: rgba(26, 26, 26, 0.98);
            z-index: 100;
            padding: 15px 15px 10px 15px;
            border-bottom: 1px solid #333;
            transition: all 0.3s ease;
        }
        .header-top-row { display: flex; align-items: center; gap: 10px; }
        
        .back-btn { 
            padding: 0 16px; height: 42px; background: #333; 
            border-radius: 12px; color: var(--accent-sunray); 
            font-weight: 600; font-size: 14px; cursor: pointer; 
            display: none; align-items: center; justify-content: center;
            border: 1px solid #444; transition: all 0.2s;
        }
        .back-btn:active { background: #444; transform: scale(0.95); }
        
        .search-box { 
            flex: 1; height: 42px; background: #252525; 
            border: 1px solid #3a3a3a; border-radius: 12px; 
            padding: 0 15px; color: #fff; font-size: 15px; transition: all 0.3s;
        }
        .search-box:focus { border-color: var(--accent-purple); box-shadow: 0 0 10px rgba(157, 0, 255, 0.2); }
        
        .tags-wrapper { display: none; gap: 8px; overflow-x: auto; padding-top: 12px; padding-bottom: 5px; scrollbar-width: none; }
        .tags-wrapper::-webkit-scrollbar { display: none; }
        .tag { white-space: nowrap; padding: 8px 16px; background: #333; border-radius: 30px; font-size: 13px; font-weight: 600; color: #bbb; cursor: pointer; border: 1px solid transparent; transition: all 0.3s; }
        .tag.active { background: var(--accent-purple); color: #fff; box-shadow: 0 4px 15px rgba(157, 0, 255, 0.4); }

        /* --- CONTENT --- */
        .main-content { padding: 80px 15px 80px 15px; transition: padding-top 0.3s ease; }

        /* --- PROGRESS CARD (RANKS) --- */
        .progress-card {
            background: linear-gradient(145deg, #2a2a2a, #222222);
            border-radius: var(--radius); padding: 20px;
            margin-bottom: 20px; border: 1px solid #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative; overflow: hidden;
        }
        .progress-card.ascended {
            background: linear-gradient(135deg, #10002b, #240046);
            border: 1px solid #00d4ff;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
        }
        .progress-card.ascended::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.2), transparent);
            animation: shimmer 1.5s infinite; pointer-events: none;
        }

        .rank-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
        .rank-title { font-size: 12px; color: #888; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }
        .rank-name { font-size: 18px; font-weight: 900; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
        
        .rank-name.gold { color: var(--accent-sunray); text-shadow: 0 0 10px rgba(227, 188, 87, 0.4); }
        .rank-name.ascended-text {
            background: linear-gradient(90deg, #E3BC57, #9D00FF, #00d4ff);
            background-size: 200%; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: gradientMove 3s linear infinite; font-size: 20px; letter-spacing: 1px;
        }
        @keyframes gradientMove { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }

        .progress-stats { font-size: 12px; color: var(--accent-purple); font-weight: 600; }
        .progress-bar-bg { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; position: relative; margin-bottom: 15px; }
        .progress-bar-fill { height: 100%; background: var(--accent-sunray); width: 0%; border-radius: 4px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 10px rgba(227, 188, 87, 0.5); }

        /* ACHIVEMENTS ROW */
        .achievements-row {
            display: flex; gap: 8px; justify-content: space-between;
            padding-top: 15px; border-top: 1px solid #3d3d3d;
            overflow-x: auto; scrollbar-width: none;
        }
        .badge {
            width: 40px; height: 40px; min-width: 40px; border-radius: 50%;
            background: #252525; border: 1px solid #444;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: #666; filter: grayscale(1); opacity: 0.4;
            transition: all 0.3s; cursor: pointer;
        }
        .badge.unlocked {
            filter: grayscale(0); opacity: 1;
            background: #2d2d2d;
            color: #fff;
        }
        .badge:active { transform: scale(0.9); }

        .badge.secret { border: 1px dashed #555; color: #555; font-size: 14px; }
        .badge.secret.unlocked {
            border: 1px solid #00d4ff;
            background: rgba(0, 212, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 10px rgba(0, 212, 255, 0.3); } 50% { box-shadow: 0 0 25px rgba(0, 212, 255, 0.7); } 100% { box-shadow: 0 0 10px rgba(0, 212, 255, 0.3); } }

        /* --- TOAST --- */
        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: rgba(20, 20, 20, 0.95); border: 1px solid var(--accent-purple);
            color: #fff; padding: 12px 20px; border-radius: 30px;
            font-size: 14px; font-weight: 600; z-index: 3000;
            opacity: 0; visibility: hidden; transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); text-align: center;
            white-space: nowrap;
        }
        .toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }

        /* --- MODAL CELEBRATION --- */
        .celebration-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(4px);
            z-index: 2000; display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.4s;
        }
        .celebration-modal.active { opacity: 1; visibility: visible; }
        
        .celebration-card {
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
            border: 2px solid var(--accent-sunray);
            border-radius: 24px; padding: 30px 20px;
            width: 85%; max-width: 350px; text-align: center;
            transform: scale(0.8); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 0 50px rgba(227, 188, 87, 0.2);
        }
        .celebration-modal.active .celebration-card { transform: scale(1); }
        
        .cel-icon { font-size: 60px; margin-bottom: 20px; filter: drop-shadow(0 0 20px var(--accent-sunray)); }
        .cel-title { color: #888; font-size: 12px; letter-spacing: 2px; text-transform: uppercase; font-weight: 700; margin-bottom: 10px; }
        .cel-name { 
            color: #fff; font-size: 24px; font-weight: 900; text-transform: uppercase; 
            margin-bottom: 15px; line-height: 1.2;
        }
        .cel-msg { color: #ccc; font-size: 14px; margin-bottom: 30px; line-height: 1.4; font-style: italic; }
        .cel-btn {
            background: var(--accent-sunray); color: #000;
            border: none; padding: 16px 30px; border-radius: 16px;
            font-weight: 900; font-size: 16px; text-transform: uppercase;
            width: 100%; cursor: pointer; box-shadow: 0 5px 20px rgba(227, 188, 87, 0.4);
        }
        .cel-btn:active { transform: scale(0.97); }

        /* --- SPECIAL CARDS --- */
        .special-card {
            margin-bottom: 20px; border-radius: var(--radius); padding: 25px 20px;
            cursor: pointer; position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: center;
            transition: transform 0.1s; min-height: 100px;
            box-shadow: var(--shadow);
        }
        .special-card::after { content: ''; position: absolute; top: 0; left: 0; width: 50%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent); animation: shimmer 3s infinite cubic-bezier(0.4, 0.0, 0.2, 1); }
        .special-card:active { transform: scale(0.98); }

        .card-red { background: linear-gradient(135deg, #420000 0%, #1a0000 100%); border: 1px solid var(--danger-red); border-left: 6px solid var(--danger-red); }
        .card-gold { background: linear-gradient(135deg, #3a2e00 0%, #1a1a1a 100%); border: 1px solid var(--accent-sunray); border-left: 6px solid var(--accent-sunray); }
        .card-purple { background: linear-gradient(135deg, #2a003a 0%, #1a1a1a 100%); border: 1px solid var(--accent-purple); border-left: 6px solid var(--accent-purple); display: none; }

        .sp-title { font-weight: 900; font-size: 19px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; z-index: 2; }
        .red-text { color: #ff4d4d; text-shadow: 0 2px 10px rgba(207, 10, 10, 0.5); }
        .gold-text { color: var(--accent-sunray); text-shadow: 0 2px 10px rgba(227, 188, 87, 0.4); }
        .purple-text { color: var(--accent-purple); text-shadow: 0 2px 10px rgba(157, 0, 255, 0.4); }
        .sp-desc { color: #ddd; font-size: 13px; line-height: 1.3; z-index: 2; opacity: 0.9; font-weight: 500; }
        .sp-bg-icon { position: absolute; right: -10px; bottom: -15px; font-size: 80px; opacity: 0.1; transform: rotate(-20deg); filter: grayscale(100%); z-index: 0; pointer-events: none; }

        #homeWrapper { display: flex; flex-direction: column; }
        #homeTilesContainer { display: grid; grid-template-columns: repeat(auto-fit, minmax(145px, 1fr)); gap: 15px; margin-top: 10px; }
        
        .category-tile {
            background: linear-gradient(145deg, #2a2a2a, #222222);
            border-radius: var(--radius); padding: 25px 20px; cursor: pointer;
            position: relative; overflow: hidden; border: 1px solid #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 140px; transition: transform 0.1s;
        }
        .category-tile:active { transform: scale(0.97); border-color: var(--accent-sunray); background: linear-gradient(145deg, rgba(227, 188, 87, 0.15), rgba(157, 0, 255, 0.15)); }
        .tile-icon { font-size: 32px; margin-bottom: 15px; }
        .tile-title { font-size: 15px; font-weight: 800; color: #fff; text-transform: uppercase; letter-spacing: 0.5px; line-height: 1.2; word-break: break-word; hyphens: auto; }
        .tile-count { font-size: 12px; color: #777; margin-top: 8px; font-weight: 500; }

        /* --- LIST & POSTS --- */
        #listViewContainer { display: none; }
        .section-header { margin-top: 25px; margin-bottom: 15px; display: flex; align-items: center; color: var(--accent-sunray); font-weight: 800; font-size: 14px; text-transform: uppercase; letter-spacing: 1.2px; }
        .section-header::before { content: ''; display: inline-block; width: 4px; height: 18px; background: var(--accent-purple); margin-right: 12px; border-radius: 4px; box-shadow: 0 0 10px var(--accent-purple); }
        .posts-list { display: flex; flex-direction: column; gap: 12px; }
        .post-card { background-color: var(--card-bg); padding: 18px; border-radius: var(--radius); cursor: pointer; position: relative; overflow: hidden; border: 1px solid #3a3a3a; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .post-card:active { background-color: #383838; border-color: var(--accent-sunray); }
        .post-title { font-size: 15px; line-height: 1.5; font-weight: 600; color: #e0e0e0; display: flex; justify-content: space-between; align-items: flex-start; }
        .is-read { opacity: 0.5; }
        .read-icon { color: var(--accent-purple); font-weight: bold; margin-left: 10px; font-size: 14px; }
        .post-locked { border-left: 3px solid var(--danger-red); background: rgba(207, 10, 10, 0.05); }
        .lock-icon { color: var(--danger-red); margin-left: 10px; }
        .highlight { background: var(--highlight-bg); color: #fff; padding: 0 2px; border-radius: 4px; }

        /* --- BOTTOM SHEET --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); z-index: 500; opacity: 0; visibility: hidden; transition: opacity 0.2s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .bottom-sheet { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--sheet-bg); border-top-left-radius: 25px; border-top-right-radius: 25px; padding: 25px 20px 45px 20px; z-index: 600; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 -10px 50px rgba(0,0,0,0.7); max-height: 85vh; overflow-y: auto; border-top: 1px solid #333; }
        .bottom-sheet.active { transform: translateY(0); }
        
        .sheet-handle { width: 50px; height: 6px; background: #444; border-radius: 10px; margin: 0 auto 25px auto; }
        .sheet-category { color: var(--accent-purple); font-size: 13px; font-weight: 700; text-transform: uppercase; margin-bottom: 12px; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        .sheet-title { font-size: 24px; font-weight: 800; line-height: 1.3; margin-bottom: 30px; color: #fff; }
        .sheet-actions { display: flex; gap: 10px; margin-bottom: 30px; }
        
        /* –ö–ù–û–ü–ö–ò –í –®–¢–û–†–ö–ï (–§–ò–ö–°) */
        .btn-main { flex: 1; text-align: center; background: var(--accent-sunray); color: #000; font-weight: 900; font-size: 16px; text-transform: uppercase; padding: 16px; border-radius: 14px; border: none; cursor: pointer; box-shadow: 0 5px 20px rgba(227, 188, 87, 0.3); transition: transform 0.1s; }
        .btn-main:active { transform: scale(0.97); }
        
        .btn-icon { flex: 0 0 52px; height: 52px; display: flex; align-items: center; justify-content: center; background: rgba(157, 0, 255, 0.15); color: var(--accent-purple); border: 1px solid var(--accent-purple); border-radius: 14px; font-weight: 700; font-size: 20px; cursor: pointer; transition: background 0.1s; backdrop-filter: blur(5px); }
        .btn-icon:active { background: rgba(157, 0, 255, 0.3); }
        .btn-icon.active { background: var(--accent-purple); color: #fff; box-shadow: 0 0 15px var(--accent-purple); }

        .related-section { border-top: 1px solid #333; padding-top: 25px; }
        .related-header { font-size: 14px; color: #888; margin-bottom: 18px; font-weight: 700; text-transform: uppercase; }
        .related-item { background: #2a2a2a; padding: 14px 18px; border-radius: 12px; margin-bottom: 12px; font-size: 14px; color: #ddd; display: flex; align-items: center; justify-content: space-between; border: 1px solid #3a3a3a; font-weight: 600; }
        .related-item:active { background: #333; border-color: #555; }
        .related-arrow { color: var(--accent-purple); font-weight: bold; }
        
        .upsell-btn { background: #252525; border: 1px solid #444; color: var(--text-sec); padding: 16px; border-radius: 14px; text-align: center; font-size: 14px; font-weight: 600; margin-top: 25px; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; }
        .upsell-btn:active { border-color: var(--accent-purple); color: var(--accent-purple); background: rgba(157, 0, 255, 0.05); }
        
        .empty-state { text-align: center; color: #666; margin-top: 60px; font-size: 15px; font-weight: 500; }
        .btn-inq-action { margin-top: 20px; font-size: 14px; padding: 14px 24px; width: auto; display: inline-block; background: linear-gradient(135deg, var(--danger-red), var(--danger-dark)); color: #FFFFFF !important; font-weight: 800; text-transform: uppercase; border-radius: 12px; border: none; box-shadow: 0 5px 20px rgba(207, 10, 10, 0.4); transition: transform 0.1s; letter-spacing: 0.5px; }
        .btn-inq-action:active { transform: scale(0.97); box-shadow: 0 2px 10px rgba(207, 10, 10, 0.3); }

        .fab-dice {
            position: fixed; bottom: 30px; right: 20px; width: 56px; height: 56px;
            background: var(--accent-purple); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; box-shadow: 0 5px 20px rgba(157, 0, 255, 0.5);
            z-index: 90; cursor: pointer; transition: transform 0.2s;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .fab-dice:active { transform: scale(0.9) rotate(20deg); }

        /* --- LOCKED CONTENT STYLES (–¢–í–û–ò –ù–û–í–´–ï –°–¢–ò–õ–ò) --- */
        .locked-content-wrapper {
            position: relative;
            margin-bottom: 30px;
            background: #222;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #333;
        }
        .locked-text-preview {
            font-size: 16px; line-height: 1.6; color: #ccc;
            filter: blur(2px); /* –£—Å–∏–ª–∏–ª –±–ª—é—Ä, —á—Ç–æ–±—ã –Ω–µ —á–∏—Ç–∞–ª–∏ */
            opacity: 0.7;
            max-height: 180px; overflow: hidden; position: relative;
            user-select: none;
        }
        .locked-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(34,34,34,0.2), rgba(34,34,34,0.9) 80%, #222 100%);
            z-index: 10; pointer-events: none;
        }
        .locked-action-container {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; z-index: 20; text-align: center;
        }
        .quote-highlight {
            border-left: 3px solid var(--danger-red); padding-left: 15px;
            font-style: italic; color: #fff; margin-bottom: 10px;
        }

    </style>
</head>
<body>

    <div class="header-container" id="listHeader">
        <div class="header-top-row">
            <div class="back-btn" id="backToHomeBtn">‚Üê</div>
            <input type="text" id="searchInput" class="search-box" placeholder="–ü–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ...">
        </div>
        <div class="tags-wrapper" id="tagsContainer"></div>
    </div>

    <div class="main-content" id="mainContent">
        
        <div id="homeWrapper">
            <div class="progress-card glide-entry" id="progressCard" style="animation-delay: 0.02s;">
                <div class="rank-header">
                    <div>
                        <div class="rank-title">–¢–≤–æ–π —Å—Ç–∞—Ç—É—Å:</div>
                        <div class="rank-name" id="rankName">üëÅ –ù–ê–ë–õ–Æ–î–ê–¢–ï–õ–¨</div>
                    </div>
                    <div class="progress-stats" id="progressStats">0%</div>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progressBar"></div>
                </div>
                <div class="achievements-row" id="achievementsRow"></div>
            </div>

            <div class="special-card card-red glide-entry" id="inqBtn" style="animation-delay: 0.05s;">
                <div class="sp-title red-text">ü©∏ –î–∞—Ä—ã –°–≤—è—Ç–æ–π –ò–Ω–∫–≤–∏–∑–∏—Ü–∏–∏</div>
                <div class="sp-desc">–ó–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª. –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞. –ñ–º–∏, –µ—Å–ª–∏ –≥–æ—Ç–æ–≤.</div>
                <div class="sp-bg-icon">‚öñÔ∏è</div>
            </div>

            <div class="special-card card-gold glide-entry" id="credoBtn" style="animation-delay: 0.1s;">
                <div class="sp-title gold-text">üèõ –§–£–ù–î–ê–ú–ï–ù–¢ & –ö–†–ï–î–û</div>
                <div class="sp-desc">–ö—Ç–æ —Ç–∞–∫–æ–π –ê–Ω–¥—Ä—ç, —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è –∫–∞–Ω–∞–ª–∞, –Ω–æ–≤–∏—á–∫–∞–º –∏ –±–∏–æ—Ö–∏–º–∏—è —É—Å–ø–µ—Ö–∞.</div>
                <div class="sp-bg-icon">üß≠</div>
            </div>

            <div class="special-card card-purple glide-entry" id="favBtn" style="animation-delay: 0.15s; display: none;">
                <div class="sp-title purple-text">‚≠êÔ∏è –ò–ó–ë–†–ê–ù–ù–û–ï</div>
                <div class="sp-desc">–¢–≤–æ—è –ª–∏—á–Ω–∞—è –ø–æ–¥–±–æ—Ä–∫–∞. <span id="favCount">0</span> –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.</div>
                <div class="sp-bg-icon">üîñ</div>
            </div>

            <div id="homeTilesContainer"></div>
        </div>

        <div id="listViewContainer">
             <div class="posts-list" id="postsContainer"></div>
        </div>

    </div>

    <div class="fab-dice" id="randomBtn">üé≤</div>
    
    <div id="celebrationModal" class="celebration-modal">
        <div class="celebration-card">
            <div class="cel-icon" id="celIcon">üèÜ</div>
            <div class="cel-title">–î–û–°–¢–ò–ñ–ï–ù–ò–ï –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ê–ù–û</div>
            <div class="cel-name" id="celName">–ò–ú–Ø –ê–ß–ò–í–ö–ò</div>
            <div class="cel-msg" id="celMsg">–û–ø–∏—Å–∞–Ω–∏–µ</div>
            <button class="cel-btn" onclick="closeCelModal()">–ó–ê–ï–ë–ò–°–¨</button>
        </div>
    </div>

    <div id="toast" class="toast">–ò–Ω—Ñ–æ</div>

    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="bottom-sheet" id="postSheet">
        <div class="sheet-handle"></div>
        <div class="sheet-category" id="sheetCategory">–†–£–ë–†–ò–ö–ê</div>
        <div class="sheet-title" id="sheetTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏</div>
        
        <div id="lockedContentArea" style="display: none;"></div>

        <div class="sheet-actions" id="sheetActions">
            <button class="btn-main" id="readBtn">–ß–ò–¢–ê–¢–¨ –°–¢–ê–¢–¨–Æ üî•</button>
            <button class="btn-icon" id="favSheetBtn">‚≠êÔ∏è</button>
            <button class="btn-icon" id="shareBtn">üì§</button>
        </div>
        
        <button class="btn-inq-action" id="lockedBtn" style="display:none; width:100%; margin-top:0;">–î–û–°–¢–£–ü–ù–û –í –ò–ù–ö–í–ò–ó–ò–¶–ò–ò üîí</button>

        <div class="related-section">
            <div class="related-header">–ï—â—ë –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ:</div>
            <div id="relatedContainer"></div>
        </div>
        <button class="upsell-btn" id="upsellBtn">üéÅ –ó–∞–±—Ä–∞—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã (–ë–æ—Ç)</button>
    </div>

    <script src="data.js"></script>

    <script>
        const tg = window.Telegram.WebApp;
        let db = []; 
        const categoriesMap = new Map();
        const uniqueCategoriesList = []; 
        
        const STATE_KEY = 'mm_hub_state_v8'; 
        const READ_KEY = 'mm_read_posts';
        const FAV_KEY = 'mm_favorites';
        const NOTIFIED_KEY = 'mm_notified_achievements'; 
        const STATE_TTL = 15 * 60 * 1000; 

        // –ö–û–ù–§–ò–ì –ê–ß–ò–í–û–ö
        const ACHIEVEMENTS_CONFIG = {
            "‚öîÔ∏è": { name: "–°–¢–û–ò–ö", icon: "‚öîÔ∏è", color: "#e74c3c", msg: "–¢—ã –ø–æ–∑–Ω–∞–ª –¥–∑–µ–Ω –≤ —Ö–∞–æ—Å–µ. –°—Ç–∞–ª—å –∑–∞–∫–∞–ª–∏–ª–∞—Å—å." },
            "üß†": { name: "–ú–ï–ù–¢–ê–õ–ò–°–¢", icon: "üß†", color: "#3498db", msg: "–¢–≤–æ–π —Ä–∞–∑—É–º —á–∏—Å—Ç –æ—Ç –±–∞–≥–æ–≤. –ú–∞—Ç—Ä–∏—Ü–∞ –ø–æ–≤–µ—Ä–∂–µ–Ω–∞." },
            "üíÉ": { name: "–ö–ê–ó–ê–ù–û–í–ê", icon: "üíÉ", color: "#e056fd", msg: "–¢—ã –∑–Ω–∞–µ—à—å –æ –∂–µ–Ω—â–∏–Ω–∞—Ö –±–æ–ª—å—à–µ, —á–µ–º –æ–Ω–∏ —Å–∞–º–∏." },
            "üíä": { name: "–ú–£–¢–ê–ù–¢", icon: "üíä", color: "#2ecc71", msg: "–¢–≤–æ—è –±–∏–æ—Ö–∏–º–∏—è –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º. –¢—ã —Å–≤–µ—Ä—Ö—á–µ–ª–æ–≤–µ–∫." },
            "üéô": { name: "–≠–†–£–î–ò–¢", icon: "üéô", color: "#f39c12", msg: "–¢—ã –≤–ø–∏—Ç–∞–ª –≤—Å—é –±–∞–∑—É. –¢–≤–æ–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –∑–∞—à–∫–∞–ª–∏–≤–∞–µ—Ç." },
            "üìú": { name: "–õ–ï–¢–û–ü–ò–°–ï–¶", icon: "üìú", color: "#f1c40f", msg: "–¢—ã —Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –¥—Ä–µ–≤–Ω–∏—Ö –∑–Ω–∞–Ω–∏–π –∏ –ª–µ–≥–µ–Ω–¥." }
        };

        let pendingAchievements = [];
        let currentViewState = 'home';
        let currentCategory = null;
        let searchQuery = "";

        // DOM ELEMENTS
        const listHeader = document.getElementById('listHeader');
        const backToHomeBtn = document.getElementById('backToHomeBtn');
        const homeTilesContainer = document.getElementById('homeTilesContainer');
        const listViewContainer = document.getElementById('listViewContainer');
        const postsContainer = document.getElementById('postsContainer');
        const searchInput = document.getElementById('searchInput');
        const tagsContainer = document.getElementById('tagsContainer');
        const mainContent = document.getElementById('mainContent');
        const homeWrapper = document.getElementById('homeWrapper');
        const favBtn = document.getElementById('favBtn');
        const favCount = document.getElementById('favCount');
        const randomBtn = document.getElementById('randomBtn');
        const achievementsRow = document.getElementById('achievementsRow');
        const modalOverlay = document.getElementById('modalOverlay');
        const postSheet = document.getElementById('postSheet');
        const sheetTitle = document.getElementById('sheetTitle');
        const sheetCategory = document.getElementById('sheetCategory');
        const sheetActions = document.getElementById('sheetActions');
        const readBtn = document.getElementById('readBtn');
        const favSheetBtn = document.getElementById('favSheetBtn');
        const shareBtn = document.getElementById('shareBtn');
        const lockedBtn = document.getElementById('lockedBtn');
        const relatedContainer = document.getElementById('relatedContainer');
        const upsellBtn = document.getElementById('upsellBtn');
        const celebrationModal = document.getElementById('celebrationModal');
        const celIcon = document.getElementById('celIcon');
        const celName = document.getElementById('celName');
        const celMsg = document.getElementById('celMsg');
        const celBtn = document.querySelector('.cel-btn');
        const toast = document.getElementById('toast');
        const lockedContentArea = document.getElementById('lockedContentArea');
        // === –†–£–ß–ù–´–ï –û–ü–ò–°–ê–ù–ò–Ø –î–õ–Ø –ó–ê–ö–†–´–¢–´–• –ü–û–°–¢–û–í ===
        // –ö–ª—é—á ‚Äî —ç—Ç–æ 'u' (—Å—Å—ã–ª–∫–∞ –∏–ª–∏ ID –∏–∑ posts.json)
        const CUSTOM_PREVIEWS = {
            "locked_triada": `
                <div style="font-weight:800; margin-bottom:10px; color:#fff;">–¢–ï–û–†–ò–Ø –ò –ü–†–ê–ö–¢–ò–ö–ê –°–û–ë–õ–ê–ó–ù–ï–ù–ò–Ø: –≠–ø–æ—Ö–∞ –ø–æ—Å—Ç-—Å–µ–∫—Å–∞</div>
                <div style="font-size:13px; color:#777; margin-bottom:15px; text-transform:uppercase; letter-spacing:1px;">4 –ø—É—Ç–∏ —Ä–∞–∑–≤–∏—Ç–∏—è —Å–æ–±—ã—Ç–∏–π</div>
                <div class="quote-highlight">
                    "–û–Ω–∞ –±—É–¥–µ—Ç –ø–ª–∞–∫–∞—Ç—å, —É–º–æ–ª—è—Ç—å, –Ω–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É–π–¥–µ—Ç. –ü–æ—Ç–æ–º—É —á—Ç–æ —Ç—ã —Å—Ç–∞–ª –µ—ë –Ω–∞—Ä–∫–æ—Ç–∏–∫–æ–º..."
                </div>
                <p>–ù–∞—á–∏–Ω–∞—è —Å —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞, –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è —Å–æ–±—ã—Ç–∏–π –Ω–∞—á–∏–Ω–∞—é—Ç –º–Ω–æ–∂–∏—Ç—å—Å—è. –ù–∞—à–∞ –∑–∞–¥–∞—á–∞, –∫–∞–∫ –∏ –≤—Å–µ–≥–¥–∞, –Ω–µ —â—ë–ª–∫–∞—Ç—å –∫–ª—é–≤–æ–º –∏ –≥—Ä–∞–º–æ—Ç–Ω–æ –æ—Ü–µ–Ω–∏–≤–∞—Ç—å –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É.</p>
            `,
            
            "locked_testo": `
                <div style="font-weight:800; margin-bottom:10px; color:#fff;">–†–ê–î–ò–ö–ê–õ–¨–ù–û–ï –£–õ–£–ß–®–ï–ù–ò–ï –ó–î–û–†–û–í–¨–Ø. –ê–ù–ê–õ–ò–ó–´.</div>
                <p>–∏–¥–µ–∞–ª—å–Ω—ã–µ –±–∏–æ–º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –º—É–∂—á–∏–Ω</p>
                <p>–ö–æ—Ä–æ—á–µ, –º—ã –æ —Ç–µ–±–µ –∫–æ–µ-—á—Ç–æ –∑–Ω–∞–µ–º. –í–æ—Ç —Å–ø–∏—Å–û—á–µ–∫ —Ç–≤–æ–µ–≥–æ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ "–ø–µ—Ä—Ñ–æ–º–∞–Ω—Å–∞":</p>
                <div class="quote-highlight">
                –£—Ç—Ä–æ–º –µ–ª–µ –æ—Ç–ª–µ–ø–ª—è–µ—à—å –±–ª—è—Ç—å –≥–ª–∞–∑–∞ –≤ –Ω–∞–¥–µ–∂–¥–µ –ø–æ—Å–∫–æ—Ä–µ–µ —Å–¥–æ—Ö–Ω—É—Ç—å. –í–µ—á–µ—Ä–æ–º –∫–æ—Å–ø–ª–µ–∏—à—å Walking Dead, —Å–∏–ª –Ω–µ—Ç –¥–∞–∂–µ –Ω–∞ —Å–µ–∫—Å. –ê–±–æ–Ω–µ–º–µ–Ω—Ç –≤ –∑–∞–ª —Ç—ã –∫—É–ø–∏–ª, –∫—Ä–∞—Å–∞–≤–∞. –°—Ö–æ–¥–∏–ª –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü 1 —Ä–∞–∑ –∏ —á—É—Ç—å –Ω–µ —É–º–µ—Ä. –°—Å—ã–∫—É–µ—à—å —Å—Ö–æ–¥–∏—Ç—å –∫ –≤—Ä–∞—á—É, –ø–æ—Ç–æ–º—É —á—Ç–æ –∑–Ω–∞–µ—à—å, —à–æ —Ç–∞–º –ø–∏–∑–¥–µ—Ü –ø–æ–ª–Ω—ã–π –±—É–¥–µ—Ç."
                </div>
            `
            // –î–æ–±–∞–≤–ª—è–π —Å—é–¥–∞ –Ω–æ–≤—ã–µ –ø–æ –º–µ—Ä–µ –ø–æ—è–≤–ª–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç—ã—Ö –ø–æ—Å—Ç–æ–≤
        };

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –ó–ê–ì–†–£–ó–ö–ê ===
        async function initApp() {
            tg.ready();
            tg.expand();
            tg.setHeaderColor('#262626');
            tg.setBackgroundColor('#1a1a1a');

            try {
                const response = await fetch('posts.json?v=' + Date.now());
                if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
                db = await response.json();
                db.forEach(post => {
                    if (CUSTOM_PREVIEWS[post.u]) {
                        post.preview = CUSTOM_PREVIEWS[post.u];
                    }
                });
                calculateCategories();
                updateFavCard();
                renderHomeTiles();
                updateProgress();
                adjustPadding();
                restoreState();

            } catch (error) {
                console.error(error);
            }
            window.addEventListener('resize', adjustPadding);
        }

        function calculateCategories() {
            categoriesMap.clear();
            uniqueCategoriesList.length = 0; 
            
            db.forEach(item => {
                if(item.locked) return; 
                const parts = item.c.split(' ');
                const icon = parts[0];
                const name = parts.slice(1).join(' ');
                
                if (!categoriesMap.has(item.c)) {
                    categoriesMap.set(item.c, { icon, name, full: item.c, count: 0 });
                }
                categoriesMap.get(item.c).count++;
            });
            uniqueCategoriesList.push(...Array.from(categoriesMap.values()));
        }

        function showToast(msg) {
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function getNotified() { return JSON.parse(localStorage.getItem(NOTIFIED_KEY) || '[]'); }
        function addNotified(id) { 
            const list = getNotified();
            if(!list.includes(id)) { list.push(id); localStorage.setItem(NOTIFIED_KEY, JSON.stringify(list)); }
        }

        function closeCelModal() {
            celebrationModal.classList.remove('active');
            if(pendingAchievements.length > 0) {
                setTimeout(showNextAchievement, 500);
            }
        }

        function showNextAchievement() {
            if(pendingAchievements.length === 0) return;
            const next = pendingAchievements.shift(); 
            
            celIcon.innerText = next.icon;
            celName.innerText = next.name;
            celMsg.innerText = next.msg || "–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!";
            
            celName.style.color = "#fff";
            celName.style.textShadow = "none";
            celIcon.style.filter = "none";
            celBtn.style.background = "var(--accent-sunray)";
            celBtn.style.color = "#000";
            celBtn.style.boxShadow = "none";
            document.querySelector('.celebration-card').style.borderColor = "var(--accent-sunray)";
            document.querySelector('.celebration-card').style.boxShadow = "none";

            if(next.color) {
                celName.style.color = next.color;
                celName.style.textShadow = `0 0 15px ${next.color}66`;
                celIcon.style.filter = `drop-shadow(0 0 20px ${next.color})`;
                celBtn.style.background = next.color;
                celBtn.style.boxShadow = `0 5px 20px ${next.color}66`;
                document.querySelector('.celebration-card').style.borderColor = next.color;
                document.querySelector('.celebration-card').style.boxShadow = `0 0 50px ${next.color}33`;
            } else if(next.name === "–í–û–ó–ù–ï–°–Å–ù–ù–´–ô") {
                celName.style.color = "#00d4ff";
                celName.style.textShadow = "0 0 20px rgba(0, 212, 255, 0.6)";
                celIcon.style.filter = "drop-shadow(0 0 30px #00d4ff)";
                celBtn.style.background = "linear-gradient(90deg, #E3BC57, #9D00FF, #00d4ff)";
                celBtn.style.color = "#fff";
                document.querySelector('.celebration-card').style.borderColor = "#00d4ff";
            }

            tg.HapticFeedback.impactOccurred('heavy');
            celebrationModal.classList.add('active');
            addNotified(next.id);
        }

        function updateProgress() {
            if (!db || db.length === 0) return;

            const totalPosts = db.filter(item => !item.locked).length;
            const readList = getRead();
            const validReadCount = db.filter(item => !item.locked && readList.includes(item.u)).length;

            let percent = 0;
            if (totalPosts > 0) percent = Math.round((validReadCount / totalPosts) * 100);

            let rank = "üëÅ –ù–ê–ë–õ–Æ–î–ê–¢–ï–õ–¨";
            if (percent >= 10) rank = "üïØ –ù–ï–û–§–ò–¢";
            if (percent >= 25) rank = "üóù –ü–û–°–í–Ø–©–ï–ù–ù–´–ô";
            if (percent >= 50) rank = "üîÆ –ê–î–ï–ü–¢";
            if (percent >= 75) rank = "üßò –ú–ê–°–¢–ï–†";
            if (percent >= 100) rank = "üëë –•–†–ê–ù–ò–¢–ï–õ–¨";

            const notified = getNotified();
            
            uniqueCategoriesList.forEach(cat => {
                const config = ACHIEVEMENTS_CONFIG[cat.icon];
                if(!config) return;
                
                const catPosts = db.filter(p => p.c === cat.full && !p.locked);
                const catRead = catPosts.filter(p => readList.includes(p.u)).length;
                
                if (catPosts.length > 0 && catRead === catPosts.length) {
                    if(!notified.includes(cat.full)) {
                        if(!pendingAchievements.find(p => p.id === cat.full)) {
                            pendingAchievements.push({
                                id: cat.full,
                                name: config.name,
                                icon: config.icon,
                                color: config.color,
                                msg: config.msg
                            });
                        }
                    }
                }
            });

            let totalAchievementsCount = uniqueCategoriesList.length;
            let unlockedAchievementsCount = 0;
            uniqueCategoriesList.forEach(cat => {
                const catPosts = db.filter(p => p.c === cat.full && !p.locked);
                const catRead = catPosts.filter(p => readList.includes(p.u)).length;
                if (catPosts.length > 0 && catRead === catPosts.length) unlockedAchievementsCount++;
            });

            if (unlockedAchievementsCount > 0 && unlockedAchievementsCount === totalAchievementsCount) {
                rank = "üåå –í–û–ó–ù–ï–°–Å–ù–ù–´–ô";
                if(!notified.includes("ASCENDED")) {
                    if(!pendingAchievements.find(p => p.id === "ASCENDED")) {
                        pendingAchievements.push({
                            id: "ASCENDED",
                            name: "–í–û–ó–ù–ï–°–Å–ù–ù–´–ô",
                            icon: "üåå",
                            msg: "–¢—ã –ø—Ä–æ—à–µ–ª –ø—É—Ç—å. –¢—ã –≤–∏–¥–µ–ª –≤—Å—ë. –¢–µ–ø–µ—Ä—å —Ç—ã —Å–æ–∑–¥–∞–µ—à—å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å."
                        });
                    }
                }
            }

            const progressBar = document.getElementById('progressBar');
            const rankName = document.getElementById('rankName');
            const progressStats = document.getElementById('progressStats');
            const progressCard = document.getElementById('progressCard');

            if (progressBar && rankName) {
                progressBar.style.width = percent + '%';
                rankName.innerText = rank;
                progressStats.innerText = `${validReadCount}/${totalPosts} (${percent}%)`;

                rankName.className = 'rank-name';
                progressCard.className = 'progress-card glide-entry';

                if (rank === "üåå –í–û–ó–ù–ï–°–Å–ù–ù–´–ô") {
                    rankName.classList.add('ascended-text');
                    progressCard.classList.add('ascended');
                } else {
                    if (percent >= 50) rankName.classList.add('gold');
                    if (percent === 100) progressCard.classList.add('completed');
                }
            }

            renderAchievements(readList);
        }

        function renderAchievements(readList) {
            achievementsRow.innerHTML = '';
            
            uniqueCategoriesList.forEach(cat => {
                const config = ACHIEVEMENTS_CONFIG[cat.icon];
                if(!config) return;

                const catPosts = db.filter(p => p.c === cat.full && !p.locked);
                const catTotal = catPosts.length;
                if(catTotal === 0) return;

                const catRead = catPosts.filter(p => readList.includes(p.u)).length;
                const isUnlocked = catRead === catTotal;

                const badge = document.createElement('div');
                badge.className = `badge ${isUnlocked ? 'unlocked' : ''}`;
                badge.innerText = config.icon;
                
                if(isUnlocked) {
                    badge.style.borderColor = config.color;
                    badge.style.color = "#fff";
                    badge.style.boxShadow = `0 0 8px ${config.color}66`;
                    badge.style.background = `${config.color}22`;
                } else {
                    badge.style.borderColor = "#444";
                    badge.style.color = "#666";
                    badge.style.boxShadow = "none";
                    badge.style.background = "#252525";
                }
                
                badge.onclick = () => {
                    tg.HapticFeedback.impactOccurred('light');
                    if(isUnlocked) {
                        celIcon.innerText = config.icon;
                        celName.innerText = config.name;
                        celMsg.innerText = config.msg;
                        celName.style.color = config.color;
                        celName.style.textShadow = `0 0 15px ${config.color}66`;
                        celIcon.style.filter = `drop-shadow(0 0 20px ${config.color})`;
                        celBtn.style.background = config.color;
                        celBtn.style.boxShadow = `0 5px 20px ${config.color}66`;
                        document.querySelector('.celebration-card').style.borderColor = config.color;
                        celebrationModal.classList.add('active');
                    } else {
                        showToast(`–ü—Ä–æ—á–∏—Ç–∞–π —Ä–∞–∑–¥–µ–ª ${cat.icon}, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å`);
                    }
                };
                achievementsRow.appendChild(badge);
            });
            
            const isAscended = getNotified().includes("ASCENDED");
            const ascendedBadge = document.createElement('div');
            ascendedBadge.className = `badge secret ${isAscended ? 'unlocked' : ''}`;
            ascendedBadge.innerText = isAscended ? "üåå" : "?";
            ascendedBadge.onclick = () => {
                if(isAscended) {
                    celIcon.innerText = "üåå";
                    celName.innerText = "–í–û–ó–ù–ï–°–Å–ù–ù–´–ô";
                    celMsg.innerText = "–¢—ã –ø—Ä–æ—à–µ–ª –ø—É—Ç—å. –¢—ã –≤–∏–¥–µ–ª –≤—Å—ë.";
                    celName.style.color = "#00d4ff";
                    celIcon.style.filter = "drop-shadow(0 0 30px #00d4ff)";
                    celBtn.style.background = "linear-gradient(90deg, #E3BC57, #9D00FF, #00d4ff)";
                    document.querySelector('.celebration-card').style.borderColor = "#00d4ff";
                    celebrationModal.classList.add('active');
                } else {
                    showToast("–°–µ–∫—Ä–µ—Ç–Ω–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ. –°–æ–±–µ—Ä–∏ –∏—Ö –≤—Å–µ.");
                }
            };
            achievementsRow.appendChild(ascendedBadge);
        }

        function getRead() { return JSON.parse(localStorage.getItem(READ_KEY) || '[]'); }
        function setRead(url) { 
            const list = getRead();
            if(!list.includes(url)) { 
                list.push(url); 
                localStorage.setItem(READ_KEY, JSON.stringify(list)); 
                updateProgress(); 
            }
        }
        
        function getFav() { return JSON.parse(localStorage.getItem(FAV_KEY) || '[]'); }
        function toggleFav(url) {
            let list = getFav();
            if(list.includes(url)) list = list.filter(u => u !== url);
            else list.push(url);
            localStorage.setItem(FAV_KEY, JSON.stringify(list));
            updateFavCard();
            return list.includes(url);
        }

        function updateFavCard() {
            const list = getFav();
            favCount.innerText = list.length;
            favBtn.style.display = list.length > 0 ? 'flex' : 'none';
        }

        function adjustPadding() {
            requestAnimationFrame(() => {
                const headerHeight = listHeader.offsetHeight;
                mainContent.style.paddingTop = (headerHeight + 20) + 'px';
            });
        }

        function saveState() {
            try {
                const state = { view: currentViewState, category: currentCategory, scroll: window.scrollY, search: searchQuery, ts: Date.now() };
                localStorage.setItem(STATE_KEY, JSON.stringify(state));
            } catch (e) {}
        }

        function restoreState() {
            try {
                const raw = localStorage.getItem(STATE_KEY);
                if (!raw) return;
                const state = JSON.parse(raw);
                if (Date.now() - state.ts > STATE_TTL) { localStorage.removeItem(STATE_KEY); return; }

                if (state.view === 'list') {
                    if (state.category === "üèõ –§–£–ù–î–ê–ú–ï–ù–¢ & –ö–†–ï–î–û") showCredo(false);
                    else if (state.category === "‚≠êÔ∏è –ò–ó–ë–†–ê–ù–ù–û–ï") showFavorites(false);
                    else switchToList(state.category, false);
                    
                    if (state.search) {
                        searchQuery = state.search;
                        searchInput.value = state.search;
                        filterAndRenderList(false);
                    }
                    setTimeout(() => { window.scrollTo(0, state.scroll); }, 10);
                }
            } catch (e) {}
        }

        function switchToHome() {
            currentViewState = 'home';
            currentCategory = null;
            searchQuery = "";
            searchInput.value = "";
            backToHomeBtn.style.display = 'none';
            tagsContainer.style.display = 'none';
            listViewContainer.style.display = 'none';
            homeWrapper.style.display = 'block';
            randomBtn.style.display = 'flex';
            adjustPadding();
            window.scrollTo({ top: 0 });
            tg.HapticFeedback.impactOccurred('light');
            localStorage.removeItem(STATE_KEY);
            updateFavCard();
            updateProgress();
            if(pendingAchievements.length > 0) showNextAchievement();
        }

        function switchToList(category, animate = true) {
            currentViewState = 'list';
            currentCategory = category;
            backToHomeBtn.style.display = 'flex';
            tagsContainer.style.display = 'flex';
            homeWrapper.style.display = 'none';
            listViewContainer.style.display = 'block';
            randomBtn.style.display = 'none';
            renderTags();
            filterAndRenderList(animate);
            adjustPadding();
            if(animate) window.scrollTo({ top: 0 });
        }

        function showCredo(animate = true) {
            setupSpecialList("üèõ –§–£–ù–î–ê–ú–ï–ù–¢ & –ö–†–ï–î–û", animate);
        }
        function showFavorites(animate = true) {
            setupSpecialList("‚≠êÔ∏è –ò–ó–ë–†–ê–ù–ù–û–ï", animate);
        }

        function setupSpecialList(catName, animate) {
            currentViewState = 'list';
            currentCategory = catName;
            backToHomeBtn.style.display = 'flex';
            tagsContainer.style.display = 'flex';
            homeWrapper.style.display = 'none';
            listViewContainer.style.display = 'block';
            randomBtn.style.display = 'none';
            tagsContainer.innerHTML = '';
            const homeTag = document.createElement('div');
            homeTag.className = 'tag';
            homeTag.innerText = '‚Üê –ù–∞ –ì–ª–∞–≤–Ω—É—é';
            homeTag.onclick = switchToHome;
            tagsContainer.appendChild(homeTag);
            filterAndRenderList(animate);
            adjustPadding();
            if(animate) window.scrollTo({ top: 0 });
        }

        backToHomeBtn.addEventListener('click', switchToHome);

        function renderHomeTiles() {
            homeTilesContainer.innerHTML = '';
            let animDelay = 0.2;
            uniqueCategoriesList.forEach(catData => {
                const tile = document.createElement('div');
                tile.className = 'category-tile glide-entry';
                tile.style.animationDelay = `${animDelay}s`;
                tile.innerHTML = `
                    <div class="tile-icon">${catData.icon}</div>
                    <div>
                        <div class="tile-title">${catData.name}</div>
                        <div class="tile-count">${catData.count} –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</div>
                    </div>
                `;
                tile.onclick = () => {
                    tg.HapticFeedback.impactOccurred('medium');
                    switchToList(catData.full);
                };
                homeTilesContainer.appendChild(tile);
                animDelay += 0.05;
            });
        }

        function renderTags() {
            tagsContainer.innerHTML = '';
            const homeTag = document.createElement('div');
            homeTag.className = 'tag';
            homeTag.innerText = '–í—Å–µ';
            homeTag.onclick = () => { currentCategory = null; renderTags(); filterAndRenderList(true); };
            if(currentCategory === null) homeTag.classList.add('active');
            tagsContainer.appendChild(homeTag);

            uniqueCategoriesList.forEach(catData => {
                const btn = document.createElement('div');
                btn.className = `tag ${catData.full === currentCategory ? 'active' : ''}`;
                btn.innerText = catData.name;
                btn.onclick = () => {
                    currentCategory = catData.full;
                    renderTags();
                    filterAndRenderList(true);
                    tg.HapticFeedback.impactOccurred('light');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };
                tagsContainer.appendChild(btn);
            });
        }

        function filterAndRenderList(animate = true) {
            postsContainer.innerHTML = '';
            let animationIndex = 0;
            let filtered = [];

            if (currentCategory === "üèõ –§–£–ù–î–ê–ú–ï–ù–¢ & –ö–†–ï–î–û") {
                const credoUrls = ["https://t.me/masonsmansion/61", "https://t.me/masonsmansion/12", "https://t.me/masonsmansion/34", "https://t.me/masonsmansion/286"];
                filtered = db.filter(item => credoUrls.includes(item.u));
            } else if (currentCategory === "‚≠êÔ∏è –ò–ó–ë–†–ê–ù–ù–û–ï") {
                const favs = getFav();
                filtered = db.filter(item => favs.includes(item.u));
            } else {
                filtered = db.filter(item => {
                    const catMatch = currentCategory ? item.c === currentCategory : true;
                    const searchMatch = item.t.toLowerCase().includes(searchQuery.toLowerCase());
                    return catMatch && searchMatch;
                });
            }

            if (filtered.length === 0) {
                const msg = currentCategory === "‚≠êÔ∏è –ò–ó–ë–†–ê–ù–ù–û–ï" ? "–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º –ø–æ–∫–∞ –ø—É—Å—Ç–æ." : `–ü–æ –∑–∞–ø—Ä–æ—Å—É "<b>${searchQuery}</b>" –Ω–∏—á–µ–≥–æ –Ω–µ—Ç.`;
                postsContainer.innerHTML = `
                    <div class="empty-state glide-entry" style="animation-delay: 0.1s">
                        <div style="font-size: 40px; margin-bottom: 10px;">ü§´</div>
                        <div>${msg}</div>
                        <div style="margin-top: 5px; opacity: 0.7; font-size: 13px;">–ò—â–∏ –æ—Ç–≤–µ—Ç—ã –≤ –ò–Ω–∫–≤–∏–∑–∏—Ü–∏–∏.</div>
                        <button class="btn-inq-action" onclick="tg.openTelegramLink('https://t.me/GiftsHolyInquisition_bot')">
                            –ü–û–õ–£–ß–ò–¢–¨ –î–û–°–¢–£–ü ‚û§
                        </button>
                    </div>`;
                return;
            }

            const header = document.createElement('div');
            header.className = animate ? 'section-header glide-entry' : 'section-header';
            if(animate) header.style.animationDelay = '0.05s';
            header.innerText = currentCategory ? currentCategory : `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã (${filtered.length})`;
            postsContainer.appendChild(header);

            const readList = getRead();

            filtered.forEach(item => {
                const div = document.createElement('div');
                const isRead = readList.includes(item.u);
                
                let classes = animate ? 'post-card glide-entry' : 'post-card';
                if(item.locked) classes += ' post-locked';
                if(isRead && !item.locked) classes += ' is-read';
                
                div.className = classes;
                if (animate) div.style.animationDelay = `${0.05 + (animationIndex * 0.03)}s`;
                
                let titleHtml = item.t;
                if (searchQuery) {
                    const regex = new RegExp(`(${searchQuery})`, 'gi');
                    titleHtml = item.t.replace(regex, '<span class="highlight">$1</span>');
                }
                
                let iconsHtml = '';
                if(item.locked) iconsHtml += '<span class="lock-icon">üîí</span>';
                else if(isRead) iconsHtml += '<span class="read-icon">‚úì</span>';

                div.innerHTML = `<div class="post-title">${titleHtml} <span>${iconsHtml}</span></div>`;
                div.onclick = () => { openSheet(item); };
                postsContainer.appendChild(div);
                animationIndex++;
            });
        }

        searchInput.addEventListener('input', (e) => {
            searchQuery = e.target.value;
            if (currentViewState === 'home' && searchQuery.length > 0) switchToList(null, true);
            filterAndRenderList(true);
        });

        randomBtn.onclick = () => {
            tg.HapticFeedback.impactOccurred('heavy');
            const freePosts = db.filter(item => !item.locked);
            const randomItem = freePosts[Math.floor(Math.random() * freePosts.length)];
            openSheet(randomItem);
        }

        // === OPEN SHEET LOGIC ===
        function openSheet(item) {
            tg.HapticFeedback.impactOccurred('medium');
            sheetTitle.innerText = item.t;
            const catIcon = item.c.split(' ')[0];
            sheetCategory.innerHTML = `<span style="font-size: 18px;">${catIcon}</span> ${item.c.substring(catIcon.length)}`;
            
            // –°–ë–†–û–° (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
            lockedContentArea.innerHTML = '';
            lockedContentArea.style.display = 'none';
            sheetActions.style.display = 'flex';
            lockedBtn.style.display = 'none';

            if (item.locked) {
                sheetActions.style.display = 'none';
                
                const defaultTeaser = `
                    <div style="font-weight:800; margin-bottom:10px; color:#fff;">–ù–ï–ù–ê–í–ò–°–¢–¨ ‚Äî –¢–û–ü–õ–ò–í–û –° –ù–£–õ–ï–í–´–ú –ö–ü–î</div>
                    <div style="font-size:13px; color:#777; margin-bottom:15px; text-transform:uppercase; letter-spacing:1px;">–ø—Ä–æ–∫–æ–ø—Ç–∏–ª–∏ –ø–æ—Ç–æ–ª–æ–∫ –≥–æ—Ä—è—â–µ–π –∂–æ–ø–æ–π</div>
                    <div class="quote-highlight">
                        "–Ø —Å–∞–º –≥–æ–¥–∞–º–∏ —Å–∏–¥–µ–ª –Ω–∞ —ç—Ç–æ–π –∏–≥–ª–µ. –ß–∏—Å—Ç–∞—è, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–µ–Ω–∞–≤–∏—Å—Ç—å –∫–æ –≤—Å–µ–º—É. –ö —Å–µ–±–µ, –∫ —É–µ–±–∏—â–∞–º –≤–æ–∫—Ä—É–≥, –∫ —Å–∞–º–æ–π –µ–±–∞–Ω–æ–π —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏..."
                    </div>
                    <p>–ö–æ–≥–¥–∞ —Ç—ã –Ω–∏–∫—Ç–æ, –∑–≤–∞—Ç—å —Ç–µ–±—è –Ω–∏–∫–∞–∫, –º–∏—Ä —Ç–µ–±—è –ø–∏–∑–¥–∏—Ç –Ω–æ–≥–∞–º–∏ ‚Äî –Ω–µ–Ω–∞–≤–∏—Å—Ç—å –∫–∞–∂–µ—Ç—Å—è —Å–ø–∞—Å–µ–Ω–∏–µ–º. –ù–æ —ç—Ç–æ –ª–æ–≤—É—à–∫–∞, –∫–æ—Ç–æ—Ä–∞—è —Å–∂–∏—Ä–∞–µ—Ç —Ç–µ–±—è –∏–∑–Ω—É—Ç—Ä–∏, –ø–æ–∫–∞ —Ç—ã –¥—É–º–∞–µ—à—å, —á—Ç–æ –æ–Ω–∞ –¥–∞–µ—Ç —Ç–µ–±–µ —Å–∏–ª—É.</p>
                    <p>–ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ, –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –≤—ã–±—Ä–∞—Ç—å—Å—è –∏–∑ —ç—Ç–æ–π —è–º—ã ‚Äî —ç—Ç–æ –ø–æ–Ω—è—Ç—å –º–µ—Ö–∞–Ω–∏–∫—É...</p>
                `;

                const lockedHTML = `
                    <div class="locked-content-wrapper">
                        <div class="locked-text-preview">
                            ${item.preview ? item.preview : defaultTeaser}
                        </div>
                        <div class="locked-overlay"></div>
                        <div class="locked-action-container">
                            <div style="font-size:40px; margin-bottom:10px;">üîí</div>
                            <button class="btn-inq-action" id="lockedBtnAction" style="width:100%; box-shadow: 0 10px 30px rgba(0,0,0,0.8);">
                                –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ê–¢–¨ –í –ò–ù–ö–í–ò–ó–ò–¶–ò–ò
                            </button>
                        </div>
                    </div>
                `;
                
                lockedContentArea.innerHTML = lockedHTML;
                lockedContentArea.style.display = 'block';
                
                document.getElementById('lockedBtnAction').onclick = () => {
                    tg.HapticFeedback.impactOccurred('heavy');
                    tg.openTelegramLink('https://t.me/GiftsHolyInquisition_bot');
                };
            } else {
                sheetActions.style.display = 'flex';
                
                // 1. –ö–ù–û–ü–ö–ê –ß–ò–¢–ê–¢–¨
                readBtn.onclick = () => {
                    tg.HapticFeedback.impactOccurred('light');
                    // –í–û–¢ –¢–£–¢ –ú–´ –ó–ê–°–ß–ò–¢–´–í–ê–ï–ú –ü–†–û–ß–¢–ï–ù–ò–ï
                    setRead(item.u);
                    
                    saveState();
                    tg.openTelegramLink(item.u);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI –≤ —Ñ–æ–Ω–µ (—á—Ç–æ–±—ã –≥–∞–ª–æ—á–∫–∞ –ø–æ—è–≤–∏–ª–∞—Å—å, –∫–æ–≥–¥–∞ –≤–µ—Ä–Ω–µ—à—å—Å—è)
                    filterAndRenderList(false);
                };

                // 2. –ö–ù–û–ü–ö–ê SHARE
                shareBtn.onclick = () => {
                    tg.HapticFeedback.impactOccurred('light');
                    const shareUrl = 'https://t.me/share/url?url=' + encodeURIComponent(item.u) + '&text=' + encodeURIComponent(item.t);
                    tg.openTelegramLink(shareUrl);
                };

                // 3. –ö–ù–û–ü–ö–ê FAV
                const isFav = getFav().includes(item.u);
                updateFavBtnStyle(isFav);
                favSheetBtn.onclick = () => {
                    tg.HapticFeedback.impactOccurred('light');
                    const newState = toggleFav(item.u);
                    updateFavBtnStyle(newState);
                    if(currentCategory === "‚≠êÔ∏è –ò–ó–ë–†–ê–ù–ù–û–ï") filterAndRenderList(false);
                };
            }

            upsellBtn.onclick = () => {
                tg.HapticFeedback.impactOccurred('light');
                saveState();
                tg.openTelegramLink('https://t.me/GiftsHolyInquisition_bot');
            }
            
            const related = db.filter(p => p.c === item.c && p.u !== item.u && !p.locked).sort(() => 0.5 - Math.random()).slice(0, 3);
            relatedContainer.innerHTML = '';
            if (related.length === 0) relatedContainer.innerHTML = '<div style="color:#666; font-size:13px;">–ù–µ—Ç –ø–æ—Ö–æ–∂–∏—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</div>';
            else {
                related.forEach(rel => {
                    const div = document.createElement('div');
                    div.className = 'related-item';
                    div.innerHTML = `<span>${rel.t}</span> <span class="related-arrow">‚Üí</span>`;
                    div.onclick = () => { openSheet(rel); };
                    relatedContainer.appendChild(div);
                });
            }
            modalOverlay.classList.add('active');
            postSheet.classList.add('active');
        }

        function updateFavBtnStyle(isActive) {
            if(isActive) {
                favSheetBtn.classList.add('active');
                favSheetBtn.innerText = '‚≠êÔ∏è';
            } else {
                favSheetBtn.classList.remove('active');
                favSheetBtn.innerText = '‚òÜ';
            }
        }

        function closeSheet() { modalOverlay.classList.remove('active'); postSheet.classList.remove('active'); }
        modalOverlay.addEventListener('click', closeSheet);

        document.getElementById('inqBtn').addEventListener('click', () => {
            tg.HapticFeedback.impactOccurred('heavy');
            saveState();
            tg.openTelegramLink('https://t.me/GiftsHolyInquisition_bot');
        });

        document.getElementById('credoBtn').addEventListener('click', () => {
            tg.HapticFeedback.impactOccurred('medium');
            showCredo(true);
        });

        document.getElementById('favBtn').addEventListener('click', () => {
            tg.HapticFeedback.impactOccurred('medium');
            showFavorites(true);
        });

        // –ó–ê–ü–£–°–ö
        initApp();
    </script>
</body>
</html>